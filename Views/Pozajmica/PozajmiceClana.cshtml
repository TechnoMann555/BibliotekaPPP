@model BibliotekaPPP.Models.ViewModels.PozajmiceViewModel

@{
	ViewData["Title"] = "Pozajmice";
}

<h1>Prikaz pozajmica člana</h1>
<hr class="mb-5" />

<div class="mb-3">
	<form asp-controller="Pozajmica" asp-action="PozajmiceClana" asp-route-id="@ViewBag.ClanID" method="post">
		<select asp-for="ClanarinaRbr" class="form-select w-auto" onchange="this.form.submit()">
			<option value="" selected disabled>-- Izaberite clanarinu --</option>
			@foreach (ClanarinaBO clanarinaBO in ViewBag.Clanarine)
			{
				<!option value="@clanarinaBO.Rbr">
					@clanarinaBO.DatumPocetka.ToString("dd/MMM/yyyy")
					-
					@clanarinaBO.DatumZavrsetka.ToString("dd/MMM/yyyy")
				</!option>
			}
		</select>
	</form>
</div>
@if (ViewBag.Pozajmice != null)
{
	if (ViewBag.Pozajmice.Count == 0)
	{
		Poruka porukaKorisniku = ViewBag.PorukaKorisniku;
		await Html.RenderPartialAsync("~/Views/Shared/_PorukaKorisniku.cshtml", porukaKorisniku);
	}
	else
	{
		<table class="table table-bordered">
			<thead>
				<tr>
					<th scope="col">Građa</th>
					<th scope="col">Inventarni broj</th>
					<th scope="col">Ogranak</th>
					<th scope="col">Datum početka</th>
					<th scope="col">Rok razduženja</th>
					<th scope="col">Datum razduženja</th>
					<th scope="col">Razduživanje</th>
				</tr>
			</thead>
			<tbody>
				@foreach (PozajmicaBO pozajmicaBO in ViewBag.Pozajmice)
				{
					string pozajmicaStil = "";

					if (pozajmicaBO.DatumRazduzenja == null)
					{
						int brojPreostalihDana = pozajmicaBO.RokRazduzenja.DayNumber - DateOnly.FromDateTime(DateTime.Now).DayNumber;

						if (brojPreostalihDana > 2)
							pozajmicaStil = "table-primary";
						else if (brojPreostalihDana >= 0 && brojPreostalihDana <= 2)
							pozajmicaStil = "table-warning";
						else
							pozajmicaStil = "table-danger fw-bold";
					}

					<tr class="@pozajmicaStil">
						<td>@pozajmicaBO.NaslovGradje</td>
						<td>@pozajmicaBO.InventarniBrojPrimerka</td>
						<td>@pozajmicaBO.NazivOgrankaPrimerka</td>
						<td>@pozajmicaBO.DatumPocetka.ToString("dd/MMM/yyyy")</td>
						<td>@pozajmicaBO.RokRazduzenja.ToString("dd/MMM/yyyy")</td>
						<td>@pozajmicaBO.DatumRazduzenja?.ToString("dd/MMM/yyyy")</td>
						<td class="text-center align-middle p-0">
							@if(
								pozajmicaBO.OgranakID == ((NalogBO)ViewBag.Korisnik).BibliotekarOgranakID &&
								pozajmicaBO.DatumRazduzenja == null
							)
							{
								<button type="button" class="btn btn-primary p-1" onclick="prikaziModalRazduzivanjaPozajmice(@pozajmicaBO.ClanFk, @pozajmicaBO.ClanarinaFk, @pozajmicaBO.Rbr)">
									Razduži
								</button>
							}
						</td>
					</tr>
				}
			</tbody>
		</table>

		<div class="modal fade" id="modalRazduziPozajmicu" tabindex="-1" aria-labelledby="modalRazduziPozajmicuLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="modalRazduziPozajmicuLabel">Razduživanje pozajmice</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div id="modal-razduzi-pozajmicu-body" class="modal-body">

					</div>
				</div>
			</div>
		</div>
	}
}

@section Scripts {
	<script type="text/javascript" asp-append-version="true">
		async function prikaziModalRazduzivanjaPozajmice(clanFK, clanarinaFK, Rbr)
		{
			let myModal = new bootstrap.Modal(document.getElementById('modalRazduziPozajmicu'));

			await $.ajax({
				url: '@Url.Action("PrikaziFormuRazduzivanjaPozajmice", "Pozajmica")',
				method: 'POST',
				data: { clanID: clanFK, clanarinaID: clanarinaFK, pozajmicaRbr: Rbr },
				success: function(result) {
					$('#modal-razduzi-pozajmicu-body').html(result);
				}
			});

			await myModal.show();
		}
	</script>
}